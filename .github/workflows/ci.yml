name: Jubelio Fullstack CI/CD

on:
  push:
    branches: [master, develop, feature/**]
  pull_request:

jobs:
  build-and-test:
    name: CI - Build & Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [24]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
          cache: 'npm'

      - name: Install dependencies (npm workspaces)
        run: npm ci --no-audit --no-fund --workspaces

      - name: Build backend
        run: npm run build --workspace backend

      - name: Build frontend
        run: npm run build --workspace frontend

      - name: Run backend tests
        run: npm run test --workspace backend

      - name: Type check frontend
        run: npm run typecheck --workspace frontend

      - name: Lint all workspaces
        run: npm run lint --workspaces


  deploy:
    name: Deploy to VPS (Production)
    runs-on: ubuntu-latest
    needs: docker
    if: github.ref == 'refs/heads/release'   # only run on main release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via SSH (zero-downtime)
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_PRIVATE_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /opt/jubelio-fullstack

            echo "Pulling latest images..."
            docker compose pull

            echo "Starting new containers (keeping old alive)"
            docker compose up -d --no-deps --scale backend=2 --scale frontend=2

            echo "Waiting for new containers to become healthy..."
            sleep 20

            echo "Removing old containers gracefully"
            docker ps --filter "name=backend" --format "{{.ID}}" | head -n1 | xargs docker stop || true
            docker ps --filter "name=frontend" --format "{{.ID}}" | head -n1 | xargs docker stop || true

            echo "Zero-downtime deploy complete"
      - name: Notify Slack
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: '{"text": "Deployment to *production* succeeded!"}'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
